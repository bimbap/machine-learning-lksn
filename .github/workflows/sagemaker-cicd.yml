name: SageMaker Notebook CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'machine_learning/training.ipynb'
      - 'requirements.txt'
  # Tambahkan manual trigger untuk testing
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
    
    steps:
    - name: Debug Info
      run: |
        echo "Workflow triggered!"
        echo "Event name: ${{ github.event_name }}"
        echo "Branch: ${{ github.ref }}"
        echo "Changed files:"
        git diff --name-only HEAD^ HEAD || echo "No previous commit to compare"
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        aws --version

    - name: Test AWS Connection
      run: |
        echo "Testing AWS connection..."
        aws sts get-caller-identity
        aws sagemaker list-notebook-instances --max-items 1

    - name: Deploy to SageMaker Notebook
      run: |
        # Generate unique config name
        CONFIG_NAME="notebook-config-$(date +%Y%m%d%H%M%S)"
        
        # Get active notebook instance
        INSTANCE_NAME=$(aws sagemaker list-notebook-instances \
          --status-equals InService \
          --query "NotebookInstances[0].NotebookInstanceName" \
          --output text)
        
        if [ -z "$INSTANCE_NAME" ] || [ "$INSTANCE_NAME" = "None" ]; then
          echo "::error::No active SageMaker notebook instance found"
          exit 1
        fi

        echo "Target instance: $INSTANCE_NAME"

        # Create lifecycle configuration script
        echo '#!/bin/bash' > lifecycle_script.sh
        echo 'set -e' >> lifecycle_script.sh
        echo 'echo "Starting lifecycle configuration..."' >> lifecycle_script.sh
        echo 'sudo yum update -y' >> lifecycle_script.sh
        echo 'sudo yum install -y python3 python3-devel git wget unzip' >> lifecycle_script.sh
        echo 'sudo pip3 install --upgrade pip' >> lifecycle_script.sh
        echo 'sudo pip3 install --no-cache-dir boto3==1.28.0 pandas==1.5.0 numpy==1.21.0 scikit-learn==1.0.0' >> lifecycle_script.sh
        echo 'REPO_URL="https://github.com/handipradana/machinelearninglks.git"' >> lifecycle_script.sh
        echo 'TARGET_DIR="/home/ec2-user/SageMaker/machinelearninglks"' >> lifecycle_script.sh
        echo 'NOTEBOOK_SRC="$TARGET_DIR/machine_learning/training.ipynb"' >> lifecycle_script.sh
        echo 'NOTEBOOK_DEST="/home/ec2-user/SageMaker/training.ipynb"' >> lifecycle_script.sh
        echo 'echo "Setting up repository..."' >> lifecycle_script.sh
        echo 'if [ ! -d "$TARGET_DIR" ]; then' >> lifecycle_script.sh
        echo '  git clone "$REPO_URL" "$TARGET_DIR"' >> lifecycle_script.sh
        echo 'else' >> lifecycle_script.sh
        echo '  cd "$TARGET_DIR"' >> lifecycle_script.sh
        echo '  git fetch origin' >> lifecycle_script.sh
        echo '  git reset --hard origin/main' >> lifecycle_script.sh
        echo 'fi' >> lifecycle_script.sh
        echo 'if [ -f "$TARGET_DIR/requirements.txt" ]; then' >> lifecycle_script.sh
        echo '  echo "Installing additional requirements..."' >> lifecycle_script.sh
        echo '  sudo pip3 install --no-cache-dir -r "$TARGET_DIR/requirements.txt"' >> lifecycle_script.sh
        echo 'fi' >> lifecycle_script.sh
        echo 'echo "Configuring Jupyter..."' >> lifecycle_script.sh
        echo 'JUPYTER_CONFIG_DIR="/home/ec2-user/.jupyter"' >> lifecycle_script.sh
        echo 'JUPYTER_CONFIG="$JUPYTER_CONFIG_DIR/jupyter_server_config.py"' >> lifecycle_script.sh
        echo 'mkdir -p "$JUPYTER_CONFIG_DIR"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.open_browser = False" > "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.ip = \"0.0.0.0\"" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.port = 8888" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.token = \"\"" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.password = \"\"" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.notebook_dir = \"/home/ec2-user/SageMaker\"" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.ServerApp.allow_origin = \"*\"" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "c.FileContentsManager.delete_to_trash = False" >> "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'echo "Setting permissions..."' >> lifecycle_script.sh
        echo 'sudo chown -R ec2-user:ec2-user "$TARGET_DIR"' >> lifecycle_script.sh
        echo 'sudo chown ec2-user:ec2-user "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'sudo chmod 755 "$JUPYTER_CONFIG"' >> lifecycle_script.sh
        echo 'if [ -f "$NOTEBOOK_SRC" ]; then' >> lifecycle_script.sh
        echo '  cp "$NOTEBOOK_SRC" "$NOTEBOOK_DEST"' >> lifecycle_script.sh
        echo '  chown ec2-user:ec2-user "$NOTEBOOK_DEST"' >> lifecycle_script.sh
        echo 'fi' >> lifecycle_script.sh
        echo 'echo "Restarting Jupyter server..."' >> lifecycle_script.sh
        echo 'if pgrep -f jupyter; then' >> lifecycle_script.sh
        echo '  pkill -f jupyter' >> lifecycle_script.sh
        echo '  sleep 2' >> lifecycle_script.sh
        echo 'fi' >> lifecycle_script.sh
        echo 'sudo -u ec2-user nohup jupyter notebook --allow-root &> /var/log/jupyter.log &' >> lifecycle_script.sh
        echo 'echo "Lifecycle configuration completed successfully"' >> lifecycle_script.sh

        # Base64 encode the script
        LIFECYCLE_SCRIPT=$(base64 -w 0 lifecycle_script.sh)

        # Create new lifecycle configuration
        echo "Creating lifecycle configuration..."
        aws sagemaker create-notebook-instance-lifecycle-config \
          --notebook-instance-lifecycle-config-name "$CONFIG_NAME" \
          --on-start Content="$LIFECYCLE_SCRIPT"

        # Update notebook instance
        echo "Updating notebook instance..."
        aws sagemaker update-notebook-instance \
          --notebook-instance-name "$INSTANCE_NAME" \
          --lifecycle-config-name "$CONFIG_NAME"

        # Restart instance
        echo "Restarting instance..."
        aws sagemaker stop-notebook-instance --notebook-instance-name "$INSTANCE_NAME"
        
        # Wait for instance to stop
        echo -n "Waiting for instance to stop"
        while [ "$(aws sagemaker describe-notebook-instance \
          --notebook-instance-name "$INSTANCE_NAME" \
          --query "NotebookInstanceStatus" \
          --output text)" != "Stopped" ]; do
          echo -n "."
          sleep 5
        done
        echo ""
        
        # Start instance
        aws sagemaker start-notebook-instance --notebook-instance-name "$INSTANCE_NAME"
        
        echo "::notice::Notebook instance update initiated successfully"
        echo "::notice::Instance ARN: $(aws sagemaker describe-notebook-instance \
          --notebook-instance-name "$INSTANCE_NAME" \
          --query "NotebookInstanceArn" \
          --output text)"